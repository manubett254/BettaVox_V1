<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results | BettaVox</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Header -->
    <header class="glass-header">
        <div class="container header-container">
            <div class="logo">
                <a href="{{ url_for('index') }}">BettaVox</a>
            </div>
            <nav class="nav">
                <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                <a href="{{ url_for('upload') }}" class="nav-link">Analyze</a>
                <a href="{{ url_for('about') }}" class="nav-link">About</a>
            </nav>
            <div class="header-actions">
                <button class="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-icon">ðŸŒ“</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="results-container">
        <div class="container">
            <div class="results-header">
                <h1 class="section-title">Voice Analysis Results</h1>
                <p class="section-subtitle">Here's what your voice reveals about you</p>
            </div>

            <div class="results-card">
                <div class="results-visual">
                    <div class="avatar-circle">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 1C8.96243 1 6.5 3.46243 6.5 6.5V12C6.5 15.0376 8.96243 17.5 12 17.5C15.0376 17.5 17.5 15.0376 17.5 12V6.5C17.5 3.46243 15.0376 1 12 1Z" stroke="var(--primary)" stroke-width="2"/>
                            <path d="M4 10V12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12V10" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"/>
                            <path d="M12 17V20" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="avatar-pulse"></div>
                </div>

                <div class="results-details">
                    <div class="result-item">
                        <div class="result-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="var(--primary)" stroke-width="2"/>
                                <path d="M12 8V12L15 15" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="result-text">
                            <h3>Predicted Gender</h3>
                            <p id="gender-result" class="result-value">Loading...</p>
                        </div>
                    </div>

                    <div class="result-item">
                        <div class="result-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 6V12L16 14M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="result-text">
                            <h3>Predicted Age Group</h3>
                            <p id="age-result" class="result-value">Loading...</p>
                        </div>
                    </div>

                    <div class="result-item">
                        <div class="result-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 12H18M6 12H2M12 6V2M12 22V18" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="4" stroke="var(--primary)" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="result-text">
                            <h3>Confidence Score</h3>
                            <p id="confidence-score" class="result-value">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="feedback-section">
                <h3 class="feedback-title">Was this prediction correct?</h3>
                <div class="feedback-buttons">
                    <button onclick="submitFeedback(true)" class="btn primary-btn feedback-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Yes, it's correct
                    </button>
                    <button onclick="showCorrectionForm()" class="btn secondary-btn feedback-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        No, it's incorrect
                    </button>
                </div>

                <div id="correction-form" class="correction-form hidden">
                    <h3 class="correction-title">What was incorrect?</h3>
                    <div class="correction-options">
                        <label class="correction-option">
                            <input type="checkbox" id="wrong-gender" onchange="toggleCorrectionFields()">
                            <span class="checkmark"></span>
                            Gender
                        </label>
                        <label class="correction-option">
                            <input type="checkbox" id="wrong-age" onchange="toggleCorrectionFields()">
                            <span class="checkmark"></span>
                            Age
                        </label>
                    </div>

                    <div id="correction-fields" class="correction-fields hidden">
                        <div class="form-group">
                            <label for="correct-gender">Correct Gender:</label>
                            <select id="correct-gender" class="model-select">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="correct-age">Correct Age:</label>
                            <input type="number" id="correct-age" min="1" max="100" class="model-select">
                        </div>
                    </div>

                    <button id="submit-correction-btn" onclick="submitCorrection()" class="btn primary-btn large hidden">
                        Submit Correction
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>

                <div id="feedback-message" class="feedback-message hidden"></div>
            </div>

            <div class="action-buttons">
                <a href="{{ url_for('upload') }}" class="btn primary-btn large">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 12V20C4 20.5523 4.44772 21 5 21H19C19.5523 21 20 20.5523 20 20V12M12 3V15M12 15L8 11M12 15L16 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Analyze Another Voice
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container footer-container">
            <div class="footer-brand">
                <a href="{{ url_for('index') }}" class="footer-logo">BettaVox</a>
                <p>AI-powered voice analysis</p>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <h4>Navigation</h4>
                    <a href="{{ url_for('index') }}">Home</a>
                    <a href="{{ url_for('upload') }}">Analyze</a>
                    <a href="{{ url_for('about') }}">About</a>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 BettaVox. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let results = localStorage.getItem("analysisResults");
            if (results) {
                results = JSON.parse(results);
                document.getElementById("gender-result").textContent = results.gender || "Unknown";
                document.getElementById("age-result").textContent = results.age_group || "Unknown";
                let confidence = results.gender_confidence || 0;
                document.getElementById("confidence-score").textContent = confidence.toFixed(2) + "%";
                
                // If only age is incorrect, set the correct gender automatically
                if (!document.getElementById("wrong-gender").checked && document.getElementById("wrong-age").checked) {
                    document.getElementById("correct-gender").value = results.gender;
                }
            } else {
                console.error("Results not found in localStorage.");
                document.getElementById("result-container").innerHTML = "<p class='error-msg'>Results unavailable. Please try again.</p>";
            }
        });

        function showCorrectionForm() {
            document.querySelectorAll(".feedback-btn").forEach(btn => btn.classList.add("hidden"));
            document.getElementById("correction-form").classList.remove("hidden");
        }

        function toggleCorrectionFields() {
            let wrongGender = document.getElementById("wrong-gender").checked;
            let wrongAge = document.getElementById("wrong-age").checked;
            let correctionFields = document.getElementById("correction-fields");
            let submitBtn = document.getElementById("submit-correction-btn");
            
            correctionFields.classList.toggle("hidden", !(wrongGender || wrongAge));
            submitBtn.classList.toggle("hidden", !(wrongGender || wrongAge));
            
            // If only age is incorrect, set the correct gender automatically
            if (!wrongGender && wrongAge) {
                let results = JSON.parse(localStorage.getItem("analysisResults"));
                document.getElementById("correct-gender").value = results.gender;
            }
        }

        function submitFeedback(isCorrect) {
            let results = JSON.parse(localStorage.getItem("analysisResults"));
            fetch("/feedback", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector("meta[name='csrf-token']").getAttribute("content")
                },
                body: JSON.stringify({
                    id: results.id,
                    is_correct: isCorrect ? 1 : 0
                })
            }).then(response => {
                if (response.ok) {
                    showFeedbackMessage("Feedback submitted. Thank you!", "success");
                    document.querySelectorAll(".feedback-btn").forEach(btn => btn.classList.add("hidden"));
                } else {
                    showFeedbackMessage("Failed to submit feedback. Please try again.", "error");
                }
            }).catch(error => {
                showFeedbackMessage("Network error. Please try again.", "error");
            });
        }

        function submitCorrection() {
            let results = JSON.parse(localStorage.getItem("analysisResults"));
            let correctGender = document.getElementById("correct-gender").value;
            let correctAge = document.getElementById("correct-age").value;
            let wrongGender = document.getElementById("wrong-gender").checked;
            let wrongAge = document.getElementById("wrong-age").checked;
            
            fetch("/feedback", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector("meta[name='csrf-token']").getAttribute("content")
                },
                body: JSON.stringify({
                    id: results.id,
                    is_correct: 0,
                    corrected_gender: wrongGender ? correctGender : null,
                    corrected_age_group: wrongAge ? correctAge : null,
                    user_feedback: "User provided corrections"
                })
            }).then(response => {
                if (response.ok) {
                    document.getElementById("correction-form").innerHTML = `
                        <div class="feedback-message success">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" fill="#4BB543"/>
                                <path d="M16 9L10.5 14.5L8 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>Correction submitted. Thank you!</p>
                        </div>
                    `;
                } else {
                    showFeedbackMessage("Failed to submit correction. Please try again.", "error");
                }
            }).catch(error => {
                showFeedbackMessage("Network error. Please try again.", "error");
            });
        }

        function showFeedbackMessage(message, type) {
            const feedbackElement = document.getElementById("feedback-message");
            feedbackElement.textContent = message;
            feedbackElement.className = `feedback-message ${type}`;
            feedbackElement.classList.remove("hidden");
            
            if (type === "success") {
                feedbackElement.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" fill="#4BB543"/>
                        <path d="M16 9L10.5 14.5L8 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>${message}</span>
                `;
            } else {
                feedbackElement.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#ff4444"/>
                        <path d="M15 9L9 15M9 9L15 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>${message}</span>
                `;
            }
        }
    </script>
    <script type="module">
        import { initResultsPage } from './js/results.js';
        initResultsPage();
      </script>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>